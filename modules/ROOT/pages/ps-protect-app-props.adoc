= Protect App Property Values
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: cloudhub, jdbc, security


CloudHub 2.0 supports protecting application property values
so that the property name is visible in Anypoint Runtime Manager, 
but the value is not displayed or retrievable by any user.
CloudHub 2.0 resolves the property at runtime without exposing the sensitive information.

Internally, protected app values are encrypted and stored in a MuleSoft-managed CloudHub 2.0 properties database, which is encrypted per user organization.

// For applications deployed to CloudHub 2.0, you can use Runtime Manager to protect property values.

// For applications that you deploy using another deployment option, you must use secure property placeholder files bundled in the deployable application archive file.

[IMPORTANT]
Protected property values are a separate feature and concept from the encrypted Mule application properties that are stored in secure configuration files. 
See https://docs.mulesoft.com/mule-runtime/4.3/secure-configuration-properties[Secure Configuration Properties^] (link out from Beta docs).


== Create Protected App Property Values

To create protected app property values:

. Add the properties to the appropriate file:
+
--

In the `mule-artifact.json` file under the `secureProperties` key, list the property names to protect as a comma-separated array:

[source,json,linenums]
----
{
  "configs": [
    "testprops-app.xml"
  ],
  "secureProperties": ["password", "birthdate"],
  "redeploymentEnabled": true,
  "name": "secure-properties", # <1>
  "minMuleVersion": "4.2.1",
  "requiredProduct": "MULE_EE",
  "classLoaderModelLoaderDescriptor": {
    "id": "mule",
    "attributes": {
      "exportedResources": []
    }
  },
  "bundleDescriptorLoader": {
    "id": "mule",
    "attributes": {}
  }
}
----
<1> The `secureProperties` line defines the properties to protect, regardless of where or if they are defined.

To perform local testing, create a YAML file that defines properties with values and add it to the `src/main/resources` folder:

[source,yaml,linenums]
----
http:
    port: 8081
username: "testuser"
password: "testpass123"
birthdate: "01/01/2006"
----

////
For Mule 3, place the properties in the `mule-app.properties` file:

[source,code,lineums]
----
db.user=john
db.password=mypassword
salesforce.user=john1
salesforce.password=mysfpassword
secure.properties=db.password,salesforce.password
----

//// 
--

. Deploy the Mule application to a private space.

== Protect Property Values in Runtime Manager

If you protect a property value, users can't view or retrieve the property.

//SELECT PRIVATE SPACE SHARED
include::partial$select-private-space.adoc[tag=selectAppsPage]
. Click the app name.
. In the navigation menu, click *Settings*.
. On the *Settings* page, click the *Properties* tab.
. Click *Table view*.
. In the value field, click *Protect* and then click *Protect value* to confirm.
+
<replace screenshot>
+
.The screenshot shows (*1*) the *Properties* tab and (*2*) the key-value properties on the application *Settings* page.
image::rtm-hide-props.png[Properties tab and key-value properties on the application Settings page]

. Click *Apply Changes*. 
. Redeploy or restart the app.
+
After redeploying your app, navigate to the *Properties* tab.
The values for properties that you marked as protected are now no longer visible to you or any other user.
+
In the following example, the values for `birthdate` and `password` are protected but `username` is not:
+
<replace screenshot>
+
.The arrow shows the protected values in the *Properties* tab on the application *Settings* page.
image::rtm-hidden-props.png[Protected values in the Properties tab on the application Settings page]

After you commit the values and upload the app, the protected property values
don't appear in the console and aren't sent and received between the console and CloudHub.

After you set the property value, you can't retrieve it.
However, you can overwrite the property value with a new value. 
To update a value, enter a new value into the field.

After deploying the app with protected property values,
CloudHub 2.0 maintains the protection for those values.
Even if you edit your application file to remove the `secureProperties` definitions from your `mule-artifact.json` file and then upload that edited application file to CloudHub 2.0, the property values remain protected.


== Copy Protected Property Values between Sandboxes

When moving applications between sandboxes, the name of the property is copied, but the value is left blank.

== Encrypted Application Properties vs. Protected Property Values

Mule applications can also store properties with encrypted values using secure properties placeholders.

See https://docs.mulesoft.com/mule-runtime/4.3/secure-configuration-properties[Secure Configuration Properties^] (link out from Beta docs) for more information about creating and using secure configuration properties.

With encrypted properties, the Mule application bundles the secure property placeholder files inside the Mule application deployable archive JAR file.

A secure property placeholder combines the file containing the encrypted properties with details about the encryption algorithm that is used to encrypt the secure property values.
Secure properties are encrypted using a secret key, which shouldn't be stored in the Mule application.
Instead, you must safely (securely) pass in the secret key value at deployment time.

To safely pass the secret key into the Mule application, develop the Mule application with a property placeholder to represent the secret key value. There are then several options for how an operator can safely pass in the secret key value at deployment time.

For on-premises deployments where you have access to the file system and the command-line, the secret key can be passed in by setting a system environment variable when the Mule runtime is started up. If the file system is secure, you can also store the secret key in a special secure folder on the file system. Restrict permission for the Mule application to safely read in the secret key at startup. 

After the secret key is read into memory, it is used by the Mule application to decrypt all the other properties in the secure properties placeholder, and the decrypted values are stored in memory. To secure the Mule application, it is important to lock down access to the Mule runtime's host, so that no one can read the Mule application's memory or JVM properties.

[NOTE]
When specifying `secure properties` in the `mule-artifact.json` file for properties defined using the security properties module don't forget to add the `secure::` prefix.


== Start a CloudHub Application That Uses Encrypted Properties

Mule applications can also be developed to store encrypted properties in secure properties placeholder files.

For CloudHub deployments, none of the secure deployment approaches discussed for customer-hosted deployments is available in CloudHub, because operators do not have access to the CloudHub worker's file system, nor can they log in to a command-line to start up the CloudHub worker.

Encrypted properties can also be flagged as safely hidden application properties, by listing the encrypted property's name in the `secureProperties` entry in the Mule application's `mule-artifact.json` file. In particular, the secret key used to decrypt the encrypted properties can be set as a safely hidden property in the `mule-artifact.json` file's `secureProperties` key.

Here is an example:

.`config.yaml`
[source,yaml,linenums]
----
http:
    port: 8081
username: "testuser"
password: "![r8weir09458riwe0r9484oi]"
birthdate: "01/01/2015"
----

.`mule-artifact.json`
[source,json,linenums]
----
{
  "configs": [
    "secure-properties.xml"
  ],
  "secureProperties": ["secure::password", "birthdate", "secure.key"],
  "redeploymentEnabled": true,
  "name": "secure-properties",
  "minMuleVersion": "4.1.1",
  "requiredProduct": "MULE_EE",
  "classLoaderModelLoaderDescriptor": {
    "id": "mule",
    "attributes": {
      "exportedResources": []
    }
  },
  "bundleDescriptorLoader": {
    "id": "mule",
    "attributes": {}
  }
}
----


Then, at deployment time, the operator can type in the `secure.key` value into the Runtime Manager Properties tab for the deployment.  Because the secure key is flagged to be hidden in the console, no one can see what the operator is typing.

After the secret key is passed into the Mule application, encrypted properties are decrypted into memory just like they are with customer-hosted deployments. This is a safe thing to do in CloudHub, because CloudHub workers are highly secure, with no access to the CloudHub worker's command-line, nor is there any way for an intruder to read the CloudHub worker's memory or JVM properties.

== How to Override Encrypted Properties

Encrypted properties that are bundled with a Mule application inside a secure properties placeholder file do not appear in the Runtime Manager *Properties* tab. This keeps the values safely locked inside the Mule application.

If encrypted property names are listed in the Mule application's `secureProperties` entry in `mule-artifact.json`, once the application is deployed, the value of the encrypted property names is hidden in the Runtime Manager *Properties* tab, along with decrypted properties. 

The decrypted values are stored securely in the Mule worker's memory and the encrypted values are stored in the CloudHub database for your user account. The decrypted values are never stored in any CloudHub worker's files, nor are they ever passed between any other machines (including the Runtime Manager Console).

So for any encrypted property that is also marked as hidden in the Mule application's `secureProperties` entry, you can safely replace any encrypted property with a clear-text value. The clear-text value is then securely stored in the CloudHub properties database, and securely passed into the Mule application every time the Mule application is started.

For CloudHub deployments, the new value is hidden once the application is deployed and can never be viewed again.
For hybrid deployments, the new value remains visible, even after the redeployment.

This means that when you override a secure property in the CloudHub *Properties* tab for the application, the value doesn't need to be encrypted. In this scenario, only users who have access to the values in the application's source files when they deploy or redeploy a secure application can override secure properties. 

An example of when to override secure properties is if you need to update the database user and password stored in two properties named `db.user` and `db.password` in a production application. You can enter the new `db.user` and `db.password` values in the CloudHub *Properties* tab for the application and then start or restart the application. This allows the new application to upgrade the secure login information with zero downtime. 
After all dependent applications are migrated, the old account can be decommissioned.

[NOTE]
Use the list view in the application's *Properties* tab to update properties. If you use the text view to update properties, colons in property names must be escaped, for example: `secure\:\:someproperty`. 

== Mule Applications Deployed Only to CloudHub 

If you don't want to encryt properties for Mule applications that are deployed only to CloudHub, you can specify them in `secureProperties` in the Mule application `mule-artifact.json` file's .

== See Also

* https://docs.mulesoft.com/mule-runtime/4.3/secure-configuration-properties[Secure Configuration Properties^] (link out from Beta docs)
* xref:ps-manage-props.adoc[Change App Behavior with Properties]
* xref:ps-deploy.adoc[Deploy Apps to Private Spaces]
