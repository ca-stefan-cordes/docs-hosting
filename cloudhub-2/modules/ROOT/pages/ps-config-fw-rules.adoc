= Configuring Firewall Rules to Manage Traffic to and from a Private Space

By default, all traffic to your private space is blocked unless it is explicitly allowed in a firewall rule.

Creating a private space automatically creates these firewall rules:

* Two rules to allow inbound connections from any host:
** HTTPS: port 443
** HTTP: port 80

* Two rules to allow outbound connections from within your private space to any host:
** TCP: All ports
** HTTPS: 443

Using an API, you can also configure inbound firewall rules that use protocol other than HTTP.

To support Anypoint MQ, API Manager, and ObjectStore v2, you must allow outbound traffic on port 443 (HTTPS).

== Configure Firewall Rules

//SELECT PRIVATE SPACE SHARED
include::partial$select-private-space.adoc[tag=selectPrivateSpace]
include::partial$select-private-space.adoc[tag=clickPrivateSpaceName]
. Click the *Firewall rules* tab.
. Configure default rules for inbound traffic by selecting the *Protocol* and *Source* from the drop-down lists:
+
--
Protocol::
Protocol type:
* *HTTP*
* *HTTPS*

Source::
Source IP address:

* *Anywhere (0.0.0.0/0)*
* *Local private network*
+
This option is available only if a private network exists in the private space. 
// * *Custom CIDR*
// +
// Enter a custom CIDR in the field.

Ports::
Ports for inbound traffic are not configurable:
+
* Port 80 is reserved HTTP.
* Port 443 is reserved for HTTPS.
* Other ports below 1024 are not allowed.

--
. Configure default rules for outbound traffic by selecting the *Protocol* and *Destination* from the drop-down lists:
+
--

Protocol::
Protocol type:
+
* *All*
* *TCP*
* *UTP*
* *HTTP*
* *HTTPS*

Destination::
Destination IP address:

* *Anywhere (0.0.0.0/0)*
* *Local private network*
+
This option is available only if a private network exists in the private space. 
// * *Custom CIDR*
// +
// Enter a custom CIDR in the field.

Ports::
Port ranges for outbound traffic are configurable.

--
. Click *Add rule* to add more rules.
. To remove a firewall rule, click the trash can icon (*Delete*) for the entry.
+
image::fw-rule-delete.png[Delete icon on the Firewall rules tab]

. Click *Save Changes* or *Discard changes*.
. Restart your application.

== Configure TCP Ports for Apps

To configure protocols other than HTTP or HTTPS, configure TCP inbound rules to manage traffic for your private space. You can then use the https://anypoint.mulesoft.com/exchange/portals/anypoint-platform/f1e97bc6-315a-4490-82a7-23abe036327a.anypoint-platform/amc-application-manager/minor/4.0/console/method/%231158/[Application Manager API] to deploy an app using TCP. 

=== Find Free Ports for Your App

The port range for TCP is from 30500 to 32500. To confirm port availability, use the (name of) API that returns a list of available ports. 

The following examples show the API request and response when you use it to find free ports:

Request:

[source,json]
---- 
GET
https:/anypoint.mulesoft.com/runtimefabric/api/organizations/{organizationId}/privatespaces/{privatespaceId}/ports?available=true&count=10
----

Response: 

[source,json]
----
{
   "ports": [
       30500,
       30501,
       30502,
       30503,
       30504,
       30511,
       30512,
       30513,
       30514,
       30515
   ]
}
----


The `available` parameter enables you to alternate between used and unused ports.
The `count` parameter enables you to specify the amount of ports desired. `count` can range from 1 to 10. 

=== Deploy an App Using the Application Manager API

In the https://anypoint.mulesoft.com/exchange/portals/anypoint-platform/f1e97bc6-315a-4490-82a7-23abe036327a.anypoint-platform/amc-application-manager/minor/4.0/console/method/%231158/[Application Manager API], use the `tcp` section under `deploymentSettings` to map your TCP port and deploy your app. The mapping uses the external port to expose `portNumber` and the app level-defined port `applicationPortNumber`. There is a 10 port limit per application. 

The following example shows the request to deploy a new app using a TCP port mapping:

[source,json]
----
POST https://anypoint.mulesoft.com/amc/application-manager/api/v2/organizations/{organizationId}/environments/{environmentId}/deployments

{
 "name": "logs-app-uc01",
 "labels": [
   "beta"
 ],
 "target": {
   "provider": "MC",
   "targetId": "cfe2157f-438b-4fb8-81fe-13ec89c55545",
   "deploymentSettings": {
     "clustered": false,
     "enforceDeployingReplicasAcrossNodes": false,
//------------------------------------NEW-------------------------------------
     "tcp": {
         "inbound": {
           "ports": [
             {
               "portNumber": 30500,
               "applicationPortNumber": 9000  
             },
             {
               "portNumber": 30501,
               "applicationPortNumber": 9001  
             },
             {
               "portNumber": 30502,
               "applicationPortNumber": 9002  
             },
           ]
         }
       },
//------------------------------------NEW-------------------------------------
     "jvm": {},
     "runtimeVersion": "4.4.0:20220523-1",
     "updateStrategy": "rolling",
     "disableAmLogForwarding": false,
     "generateDefaultPublicUrl": true
   },
   "replicas": 1
 },
 "application": {
   "ref": {
     "groupId": "66310c16-bce5-43c4-b978-5945ed2f99c5",
     "artifactId": "app-with-40-schedulers",
     "version": "1.0.5",
     "packaging": "jar"
   },
   "assets": [],
   "desiredState": "STARTED",
   "configuration": {
     "mule.agent.application.properties.service": {
       "applicationName": "logs-app-uc01",
       "properties": {},
       "secureProperties": {}
     },
     "mule.agent.logging.service": {
       "artifactName": "logs-app-uc01",
       "scopeLoggingConfigurations": []
     }
   },
   "integrations": {
     "services": {
       "objectStoreV2": {
         "enabled": false
       }
     }
   },
   "vCores": "0.05"
 }
}
----

Deployments that include unavailable ports fail. Successful deployments occupy the newly mapped ports, and those ports become unavailable. If the app is deleted, the ports become available again.

=== Update an App Using the Application Manager API

In the https://anypoint.mulesoft.com/exchange/portals/anypoint-platform/f1e97bc6-315a-4490-82a7-23abe036327a.anypoint-platform/amc-application-manager/minor/4.0/console/method/%231158/[Application Manager API], use the `tcp` section under `deploymentSettings` to update TCP port and redeploy your app. 

The following example shows request to update an existing app and its body with a new TCP mapping:

[source,json]
----
PATCH
https://anypoint.mulesoft.com/amc/adam/api/organizations/{organizationId}/environments/{environmentId}/deployments/{deploymentId}

{
    "id": "id",
    "target": {
      "provider": "MC",
      "targetId": "873a9879-cca7-4211-b90e-826e98123929",
      "deploymentSettings": {
        "tcp": {
          "inbound": {
            "ports": [
              {
                "portNumber": 30507,
                "applicationPortNumber": 9007
              },
              {
                "portNumber": 30508,
                "applicationPortNumber": 9008
              },
              {
                "portNumber": 30509,
                "applicationPortNumber": 9009
              }
            ]
          }
        }
      }
    }
  }
----

Updates that include unavailable ports fail. Successful deployments occupy the newly mapped ports, and those ports become unavailable. The ports that you replaced with new mappings become available.

=== Access Your TCP App

You can access the app using VPN or a transit gateway and within the private space. Since the apps run on worker nodes, they cannot be accessed directly over the internet. The URL to access a TCP app has this structure: `{application-url}.tcp.{environment}.cloudhub.io:{port}`

For example, the URL for the app deployed in the previous examples would be `logs-app-uc01.tcp.cloudhub.io:30500`.
